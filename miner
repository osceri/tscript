shell.run("wget https://github.com/osceri/tscript/raw/main/t5")
shell.run("wget https://github.com/osceri/tscript/raw/main/t8")
require("t5")
require("t8")

local x_work = 3
local y_work = 3
local z_work = 0

function go_work()
  x, y, z = get_location()
  movex(x - x_work)
  movey(y - y_work)
  movez(z - z_work)
end

function go_home()
  x, y, z = get_location()
  movez(z_work - z)
  movey(y_work - y)
  movex(x_work - x)
end

function work()
  turtle.digDown()
  if movez(-1) then
    z_work = z_work - 1
  end
end


function repl_count_func()
  return turtle.getFuelLevel()
end

function repl_action_func()
  return turtle.refuel(1)
end

function coal_count_func()
  turtle.select(1)
  return turtle.getItemCount()
end

function coal_action_func()
  set_orientation(1)
  return turtle.suck(4)
end

function inventory_count_func()
  local slot = 0
  for i = 2,16 do
    turtle.select(i)
    if turtle.getItemCount() < 1 then
      slot = slot + 1
    end
  end
  return 15 - slot
end

function inventory_action_func()
  set_orientation(2)
  return turtle.drop(4)
end


local inv_good = false
local coal_good = false
local fuel_good = false

while true do
  x, y, z = get_location()
  O = get_orientation()
  print("Pos: ", x, y, z, ", Dir: ", O)
  if inv_good and coal_good and fuel_good then
    go_work()
    work()
  else
    go_home()
    print("Checking inventory;")
    inv_good = vibe_check(inventory_count_func, inventory_action_func, 13, 15)
    print("")
    print("Checking coal;")
    coal_good = vibe_check(coal_count_func, coal_action_func, 8, 16)
    print("")
    print("Checking fuel;")
    fuel_good = vibe_check(repl_count_func, repl_action_func, 1000, 2000)
    print("")
  end
end
